import pandas as pd
import qrcode
import os

def generate_qr_codes_for_publisher(excel_file_path, link_column_name):
    """
    Generate QR codes as image files for Publisher mail merge
    Creates Excel file with full paths that work with Publisher 365
    """
    
    try:
        print("🔍 Step 1: Reading Excel file...")
        df = pd.read_excel(excel_file_path)
        print(f"✅ Found {len(df)} rows of data")
        
        print("🔍 Step 2: Checking column name...")
        if link_column_name not in df.columns:
            print(f"❌ Error: Column '{link_column_name}' not found!")
            print(f"💡 Available columns: {list(df.columns)}")
            return False
        
        print("📁 Step 3: Creating QR codes folder...")
        qr_folder = "QR_Images"
        os.makedirs(qr_folder, exist_ok=True)
        print(f"✅ Folder created: {qr_folder}")
        
        print("⚡ Step 4: Generating QR code files...")
        qr_paths = []
        successful_qrs = 0
        
        # Process each row
        for index, row in df.iterrows():
            row_number = index + 1
            website_link = row[link_column_name]
            
            # Skip empty/invalid links
            if pd.isna(website_link) or str(website_link).strip() == '':
                qr_paths.append('')
                print(f"  ⏭️  Row {row_number}: Skipping (empty link)")
                continue
            
            try:
                website_link = str(website_link).strip()
                print(f"  🔄 Row {row_number}: Creating QR for {website_link[:50]}...")
                
                # Generate QR code
                qr = qrcode.QRCode(
                    version=1,
                    error_correction=qrcode.constants.ERROR_CORRECT_L,
                    box_size=10,  # Good size for printing
                    border=4,
                )
                qr.add_data(website_link)
                qr.make(fit=True)
                
                # Create QR code image
                qr_image = qr.make_image(fill_color="black", back_color="white")
                
                # Save as PNG file
                filename = f"QR_{row_number:03d}.png"
                file_path = os.path.join(qr_folder, filename)
                qr_image.save(file_path)
                
                # Store full path (what works with Publisher)
                full_path = os.path.abspath(file_path)
                qr_paths.append(full_path)
                successful_qrs += 1
                print(f"  ✅ Row {row_number}: Saved as {filename}")
                
            except Exception as e:
                qr_paths.append('')
                print(f"  ❌ Row {row_number}: Error - {str(e)}")
        
        print("📝 Step 5: Creating Excel file for Publisher...")
        # Add QR code paths to dataframe
        df['QR_Code_Full_Path'] = qr_paths
        
        # Save Excel file
        output_file = excel_file_path.replace('.xlsx', '_for_Publisher.xlsx')
        df.to_excel(output_file, index=False)
        
        print(f"✅ SUCCESS!")
        print(f"📊 Summary: {successful_qrs} QR codes created")
        print(f"📁 QR images saved in: {qr_folder}")
        print(f"📄 Excel file for Publisher: {output_file}")
        
        print(f"\n🎯 Publisher Mail Merge Instructions:")
        print(f"=" * 50)
        print(f"1. Open Publisher and start mail merge with: {output_file}")
        print(f"2. Insert text fields normally (Insert > Merge Field)")
        print(f"3. For QR codes: Mailings > Picture")
        print(f"4. Select 'QR_Code_Full_Path' from the dropdown")
        print(f"5. Position and resize QR code as needed")
        print(f"6. Preview or complete the merge!")
        
        return True
        
    except Exception as e:
        print(f"❌ Error: {str(e)}")
        return False

def run_qr_generator():
    """Simple interactive function to run the QR generator"""
    
    print("🚀 QR Code Generator for Publisher Mail Merge")
    print("=" * 50)
    
    # Get file path
    excel_file = input("📂 Enter your Excel file name (with .xlsx): ").strip()
    
    # Check if file exists
    if not os.path.exists(excel_file):
        print(f"❌ File '{excel_file}' not found in current directory")
        print(f"📁 Current directory: {os.getcwd()}")
        print("📋 Excel files in current directory:")
        for file in os.listdir('.'):
            if file.endswith('.xlsx'):
                print(f"   - {file}")
        return
    
    # Show available columns
    try:
        df = pd.read_excel(excel_file)
        print("\n📋 Available columns in your Excel file:")
        for i, col in enumerate(df.columns, 1):
            print(f"   {i}. {col}")
    except Exception as e:
        print(f"❌ Error reading file: {e}")
        return
    
    # Get column name
    link_column = input("\n🔗 Enter the exact name of your website link column: ").strip()
    
    # Run the generator
    print(f"\n🚀 Processing your file...")
    success = generate_qr_codes_for_publisher(excel_file, link_column)
    
    if success:
        print("\n🎉 All done! You're ready for Publisher mail merge!")
        print("\n💡 Remember: Use 'Mailings > Picture > QR_Code_Full_Path' in Publisher")
    else:
        print("\n😞 Something went wrong. Please check the error messages above.")

# Run the script
if __name__ == "__main__":
    run_qr_generator()
